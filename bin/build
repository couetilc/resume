#!/usr/bin/env bash
export DOCKER_BUILDKIT=1

# Build all targets in parallel, sharing cache
docker build \
  --target builder \
  --cache-from resume:latest \
  --cache-from resume:dev \
  --cache-from resume:runtime \
  -t resume:latest \
  -f $root/Dockerfile $root &

docker build \
  --target dev \
  --cache-from resume:latest \
  --cache-from resume:dev \
  --cache-from resume:runtime \
  -t resume:dev \
  -f $root/Dockerfile $root &

docker build \
  --target runtime \
  --cache-from resume:latest \
  --cache-from resume:dev \
  --cache-from resume:runtime \
  -t resume:runtime \
  -f $root/Dockerfile $root &

wait

rm -rf "$root/dist/"

docker create --name tmp-resume-dist resume:latest
docker cp tmp-resume-dist:/app/dist "$root/dist"
docker rm tmp-resume-dist
